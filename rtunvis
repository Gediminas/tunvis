#!/usr/bin/env bash

PID=0

destroy() {
    kill $PID
    killall tunvis

    # iptables -t mangle -D OUTPUT -j MARK --set-mark 1
    # iptables -t mangle -D PREROUTING -i tun12 -j MARK --set-mark 0/1
    # iptables -t mangle -D PREROUTING -i enp0s3 -j MARK --set-mark 2

    iptables -t mangle -D PREROUTING -i tunvis2 -j MARK --set-mark 9
    iptables -t mangle -D PREROUTING -i enp0s3 -j MARK --set-mark 2
    iptables -t mangle -D OUTPUT -j MARK --set-mark 1

    ip route del table 1 default via 10.0.0.1
    ip route del table 2 default via 10.0.0.2
    ip route del table 9 default via 192.168.101.1

    ip rule del fwmark 9 table 9
    ip rule del fwmark 2 table 2
    ip rule del fwmark 1 table 1

}

trap ctrl_c INT
ctrl_c() {
    echo "** Trapped CTRL-C"
    destroy
    exit
}

killall tunvis

while true; do
  ./tunvis &
  PID=$!
  inotifywait ./tunvis
  destroy
  sleep 2
done
